#!/usr/bin/env bash

# ==============================================================================
# Pre-commit Hook for ShellCheck
# ==============================================================================
# This hook runs ShellCheck on all shell scripts before allowing a commit.
#
# Installation:
#   1. Make this file executable: chmod +x .githooks/pre-commit
#   2. Configure git to use this hooks directory:
#      git config core.hooksPath .githooks
#
# To skip this check for a specific commit:
#   git commit --no-verify
# ==============================================================================

set -eo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-commit checks...${NC}"
echo

# Check if shellcheck is installed
if ! command -v shellcheck &> /dev/null; then
    echo -e "${RED}[ERROR]${NC} ShellCheck is not installed!"
    echo
    echo "Install ShellCheck:"
    echo "  macOS:   brew install shellcheck"
    echo "  Ubuntu:  sudo apt install shellcheck"
    echo "  Fedora:  sudo dnf install ShellCheck"
    echo "  Arch:    sudo pacman -S shellcheck"
    echo
    echo -e "${YELLOW}Skipping ShellCheck for now...${NC}"
    exit 0
fi

# Get the root directory of the repository
REPO_ROOT="$(git rev-parse --show-toplevel)"

# Run shellcheck script if it exists
if [ -f "$REPO_ROOT/scripts/run-shellcheck.sh" ]; then
    echo -e "${YELLOW}Running ShellCheck on all shell scripts...${NC}"
    echo

    if "$REPO_ROOT/scripts/run-shellcheck.sh" --summary; then
        echo
        echo -e "${GREEN}✓ ShellCheck passed!${NC}"
        exit 0
    else
        echo
        echo -e "${RED}✗ ShellCheck failed!${NC}"
        echo
        echo "Please fix the issues above before committing."
        echo "To skip this check, use: git commit --no-verify"
        exit 1
    fi
else
    echo -e "${YELLOW}ShellCheck runner script not found, skipping...${NC}"
    exit 0
fi
