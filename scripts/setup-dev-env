#!/usr/bin/env bash
# ==============================================================================
# Cross-Platform Development Environment Setup
# ==============================================================================
# Automated setup script for development environment across macOS and Linux
# Installs packages, configures development tools, and sets up dotfiles
#
# Usage: ./setup-dev-env [options] [components]
# Options:
#   --dry-run     Show what would be installed without actually installing
#   --verbose     Enable verbose output
#   --update      Update existing packages before installing new ones
#   --minimal     Install minimal development environment only
#   --full        Install complete development environment (default)
# Components:
#   core          Install core system tools
#   shell         Install and configure shell environment
#   dev-tools     Install development tools and languages
#   editors       Install editors and IDE configurations
#   terminal      Install terminal emulators and multiplexers
#   services      Install and configure system services
#   themes        Install themes and visual configurations
#   all           Install all components (default)
# ==============================================================================

set -e

# Source platform detection utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Load cross-platform utilities if available
if [[ -f "$DOTFILES_DIR/zsh/.zsh_cross_platform" ]]; then
    source "$DOTFILES_DIR/zsh/.zsh_cross_platform"
else
    # Fallback platform detection
    detect_os() {
        case "$(uname -s)" in
            Darwin*)    echo "macos" ;;
            Linux*)     echo "linux" ;;
            *)          echo "unknown" ;;
        esac
    }

    detect_linux_distro() {
        if [[ -f /etc/os-release ]]; then
            . /etc/os-release
            echo "$ID"
        elif command -v lsb_release >/dev/null 2>&1; then
            lsb_release -si | tr '[:upper:]' '[:lower:]'
        else
            echo "unknown"
        fi
    }
fi

# Configuration
PLATFORM=$(detect_os)
LINUX_DISTRO=""
[[ "$PLATFORM" == "linux" ]] && LINUX_DISTRO=$(detect_linux_distro)

# Script options
DRY_RUN=false
VERBOSE=false
UPDATE_PACKAGES=false
INSTALL_MODE="full"
COMPONENTS=("all")

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Utility functions
log() {
    local level="$1"
    local message="$2"
    local timestamp=$(date '+%H:%M:%S')

    case "$level" in
        INFO)  echo -e "${GREEN}[INFO]${NC}  [$timestamp] $message" ;;
        WARN)  echo -e "${YELLOW}[WARN]${NC}  [$timestamp] $message" ;;
        ERROR) echo -e "${RED}[ERROR]${NC} [$timestamp] $message" ;;
        DEBUG) [[ "$VERBOSE" == true ]] && echo -e "${BLUE}[DEBUG]${NC} [$timestamp] $message" ;;
        *)     echo -e "$message" ;;
    esac
}

info() {
    log "INFO" "$1"
}

warn() {
    log "WARN" "$1"
}

error() {
    log "ERROR" "$1"
    exit 1
}

debug() {
    log "DEBUG" "$1"
}

success() {
    echo -e "${GREEN}${BOLD}âœ“${NC} $1"
}

section() {
    echo
    echo -e "${BLUE}${BOLD}$1${NC}"
    echo -e "${BLUE}${BOLD}$(printf '=%.0s' {1..50})${NC}"
}

# Package manager abstraction
install_package() {
    local package="$1"
    local category="${2:-core}"

    debug "Installing package: $package (category: $category)"

    if [[ "$DRY_RUN" == true ]]; then
        echo "  Would install: $package"
        return 0
    fi

    case "$PLATFORM" in
        macos)
            if command -v brew >/dev/null 2>&1; then
                brew install "$package"
            else
                error "Homebrew not found. Please install Homebrew first."
            fi
            ;;
        linux)
            case "$LINUX_DISTRO" in
                ubuntu|debian)
                    sudo apt-get update -qq
                    sudo apt-get install -y "$package"
                    ;;
                fedora)
                    sudo dnf install -y "$package"
                    ;;
                arch|manjaro)
                    sudo pacman -S --noconfirm "$package"
                    ;;
                *)
                    error "Unsupported Linux distribution: $LINUX_DISTRO"
                    ;;
            esac
            ;;
        *)
            error "Unsupported platform: $PLATFORM"
            ;;
    esac
}

update_packages() {
    if [[ "$DRY_RUN" == true ]]; then
        echo "Would update system packages"
        return 0
    fi

    info "Updating system packages..."

    case "$PLATFORM" in
        macos)
            if command -v brew >/dev/null 2>&1; then
                brew update && brew upgrade
            fi
            ;;
        linux)
            case "$LINUX_DISTRO" in
                ubuntu|debian)
                    sudo apt-get update -qq && sudo apt-get upgrade -y
                    ;;
                fedora)
                    sudo dnf update -y
                    ;;
                arch|manjaro)
                    sudo pacman -Syu --noconfirm
                    ;;
            esac
            ;;
    esac

    success "System packages updated"
}

# Component installation functions
install_core_tools() {
    section "Installing Core System Tools"

    local core_packages=(
        "git"
        "curl"
        "wget"
        "stow"
        "htop"
        "tmux"
        "zsh"
        "starship"
    )

    for package in "${core_packages[@]}"; do
        info "Installing $package..."
        install_package "$package" "core"
    done

    success "Core tools installation completed"
}

install_shell_environment() {
    section "Configuring Shell Environment"

    info "Setting up Zsh as default shell..."
    if [[ "$DRY_RUN" == false ]]; then
        if [[ "$SHELL" != *"zsh"* ]]; then
            case "$PLATFORM" in
                macos)
                    sudo chsh -s /bin/zsh "$USER" 2>/dev/null || \
                    sudo chsh -s /usr/local/bin/zsh "$USER" 2>/dev/null || \
                    warn "Could not set Zsh as default shell. Please run: chsh -s \$(which zsh)"
                    ;;
                linux)
                    sudo chsh -s /bin/zsh "$USER" 2>/dev/null || \
                    sudo chsh -s /usr/bin/zsh "$USER" 2>/dev/null || \
                    warn "Could not set Zsh as default shell. Please run: chsh -s \$(which zsh)"
                    ;;
            esac
        fi
    fi

    info "Setting up dotfiles with GNU Stow..."
    if [[ "$DRY_RUN" == false ]]; then
        cd "$DOTFILES_DIR"

        # Create config directory if it doesn't exist
        mkdir -p "$HOME/.config"

        # Stow configurations
        local stow_packages=("zsh" "starship" "tmux" "neovim")

        case "$PLATFORM" in
            macos)
                stow_packages+=("ghostty" "macos")
                ;;
            linux)
                stow_packages+=("sway" "linux")
                ;;
        esac

        for package in "${stow_packages[@]}"; do
            if [[ -d "$package" ]]; then
                info "Stowing $package configuration..."
                stow -v "$package" || warn "Could not stow $package"
            fi
        done

        success "Shell environment configured"
    fi
}

install_development_tools() {
    section "Installing Development Tools"

    local dev_packages=()

    # Base development tools
    dev_packages+=("python3")

    case "$PLATFORM" in
        macos)
            # macOS uses Python 3 from Homebrew, pip included
            ;;
        linux)
            dev_packages+=("python3-pip")
            case "$LINUX_DISTRO" in
                ubuntu|debian)
                    dev_packages+=("build-essential")
                    ;;
                fedora)
                    dev_packages+=("gcc" "make" "pkg-config")
                    ;;
                arch|manjaro)
                    dev_packages+=("base-devel")
                    ;;
            esac
            ;;
    esac

    # Additional utilities
    dev_packages+=("ripgrep" "fd" "fzf" "tree" "unzip" "jq")

    # Platform-specific utilities
    case "$PLATFORM" in
        macos)
            # macOS has built-in pbcopy/pbpaste
            ;;
        linux)
            dev_packages+=("xclip")
            ;;
    esac

    for package in "${dev_packages[@]}"; do
        local actual_package="$package"

        # Handle package name variations
        case "$package" in
            "fd")
                case "$LINUX_DISTRO" in
                    ubuntu|debian) actual_package="fd-find" ;;
                esac
                ;;
        esac

        info "Installing $package..."
        install_package "$actual_package" "dev-tools"
    done

    # Install FZF shell integration
    if [[ "$DRY_RUN" == false ]] && command -v fzf >/dev/null 2>&1; then
        info "Setting up FZF shell integration..."
        $(fzf --zsh) || true
        $(fzf --bash) || true
    fi

    success "Development tools installation completed"
}

install_editors() {
    section "Installing Editors and IDEs"

    if [[ "$INSTALL_MODE" == "minimal" ]]; then
        info "Skipping editors installation (minimal mode)"
        return 0
    fi

    # Neovim installation
    info "Installing Neovim..."
    install_package "neovim" "editors"

    # Set up Neovim configuration
    if [[ "$DRY_RUN" == false ]]; then
        info "Setting up Neovim configuration..."
        mkdir -p "$HOME/.config/nvim"

        # Install vim-plug for Neovim
        if [[ ! -f "$HOME/.local/share/nvim/site/autoload/plug.vim" ]]; then
            info "Installing vim-plug for Neovim..."
            curl -fLo "$HOME/.local/share/nvim/site/autoload/plug.vim" --create-dirs \
                https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
        fi

        # Install plugins
        info "Installing Neovim plugins..."
        nvim --headless +PlugInstall +qall 2>/dev/null || true
    fi

    success "Editors installation completed"
}

install_terminal_environment() {
    section "Installing Terminal Environment"

    case "$PLATFORM" in
        macos)
            info "Installing Ghostty terminal..."
            install_package "ghostty" "terminal"

            info "Installing Rectangle window manager..."
            install_package "rectangle" "terminal"

            # Sketchybar requires special tap
            if [[ "$DRY_RUN" == false ]]; then
                info "Installing Sketchybar (requires special tap)..."
                brew tap FelixKratz/formulae 2>/dev/null || true
                install_package "sketchybar" "terminal"
            fi
            ;;
        linux)
            info "Installing Sway window manager and components..."
            local sway_packages=(
                "sway"
                "swaybg"
                "swayidle"
                "swaylock"
                "waybar"
                "foot"
                "wmenu"
                "grim"
                "mako-notifier"
            )

            for package in "${sway_packages[@]}"; do
                info "Installing $package..."
                install_package "$package" "terminal"
            done

            # Linux-specific system tools
            info "Installing Linux system utilities..."
            local system_packages=(
                "network-manager-gnome"
                "brightnessctl"
            )

            for package in "${system_packages[@]}"; do
                info "Installing $package..."
                install_package "$package" "system"
            done
            ;;
    esac

    success "Terminal environment installation completed"
}

install_services() {
    section "Installing and Configuring Services"

    if [[ "$DRY_RUN" == false ]]; then
        info "Setting up Uniclip clipboard service..."
        if [[ -f "$SCRIPT_DIR/uniclip-manager" ]]; then
            "$SCRIPT_DIR/uniclip-manager" install || warn "Could not install Uniclip service"
        else
            warn "Uniclip manager not found"
        fi
    fi

    success "Services configuration completed"
}

install_themes() {
    section "Installing Themes and Visual Configurations"

    # Install Nerd Fonts
    info "Installing Nerd Fonts..."
    case "$PLATFORM" in
        macos)
            if [[ "$DRY_RUN" == false ]]; then
                brew tap homebrew/cask-fonts 2>/dev/null || true
                install_package "font-caskaydia-mono-nerd-font" "themes"
            fi
            ;;
        linux)
            case "$LINUX_DISTRO" in
                ubuntu|debian)
                    install_package "fonts-font-awesome" "themes"
                    ;;
                fedora)
                    install_package "fontawesome-fonts" "themes"
                    ;;
                arch|manjaro)
                    install_package "ttf-font-awesome" "themes"
                    ;;
            esac
            warn "Nerd Fonts installation on Linux may require manual setup"
            ;;
    esac

    success "Themes installation completed"
}

# Installation orchestration
install_component() {
    local component="$1"

    case "$component" in
        core)
            install_core_tools
            ;;
        shell)
            install_shell_environment
            ;;
        dev-tools)
            install_development_tools
            ;;
        editors)
            install_editors
            ;;
        terminal)
            install_terminal_environment
            ;;
        services)
            install_services
            ;;
        themes)
            install_themes
            ;;
        all)
            for comp in core shell dev-tools editors terminal services themes; do
                install_component "$comp"
            done
            ;;
        *)
            warn "Unknown component: $component"
            ;;
    esac
}

# Usage information
show_usage() {
    cat << EOF
Cross-Platform Development Environment Setup

Platform detected: $PLATFORM ${LINUX_DISTRO:+($LINUX_DISTRO)}
Dotfiles directory: $DOTFILES_DIR

Usage: $0 [options] [components...]

Options:
  --dry-run     Show what would be installed without actually installing
  --verbose     Enable verbose output
  --update      Update existing packages before installing new ones
  --minimal     Install minimal development environment only
  --full        Install complete development environment (default)

Components:
  core          Install core system tools
  shell         Install and configure shell environment
  dev-tools     Install development tools and languages
  editors       Install editors and IDE configurations
  terminal      Install terminal emulators and multiplexers
  services      Install and configure system services
  themes        Install themes and visual configurations
  all           Install all components (default)

Examples:
  $0 --dry-run all              # Show what would be installed
  $0 --update core shell       # Update packages and install core + shell
  $0 --minimal core shell      # Minimal installation
  $0 --verbose dev-tools       # Verbose development tools installation

For more information, see: $DOTFILES_DIR/docs/PLATFORM_COMPARISON.md
EOF
}

# Main script logic
main() {
    # Parse command line arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --dry-run)
                DRY_RUN=true
                shift
                ;;
            --verbose)
                VERBOSE=true
                shift
                ;;
            --update)
                UPDATE_PACKAGES=true
                shift
                ;;
            --minimal)
                INSTALL_MODE="minimal"
                shift
                ;;
            --full)
                INSTALL_MODE="full"
                shift
                ;;
            --help|-h)
                show_usage
                exit 0
                ;;
            -*)
                error "Unknown option: $1"
                ;;
            *)
                COMPONENTS=("$@")
                break
                ;;
        esac
    done

    # Validate platform
    if [[ "$PLATFORM" == "unknown" ]]; then
        error "Unsupported platform. This script supports macOS and Linux."
    fi

    # Show configuration
    info "Development Environment Setup"
    info "Platform: $PLATFORM ${LINUX_DISTRO:+($LINUX_DISTRO)}"
    info "Mode: $INSTALL_MODE"
    info "Dry run: $DRY_RUN"
    info "Components: ${COMPONENTS[*]}"

    if [[ "$DRY_RUN" == true ]]; then
        warn "DRY RUN MODE - No actual installation will be performed"
    fi

    # Update packages if requested
    if [[ "$UPDATE_PACKAGES" == true ]]; then
        update_packages
    fi

    # Install components
    for component in "${COMPONENTS[@]}"; do
        install_component "$component"
    done

    # Final message
    echo
    success "Development environment setup completed!"

    if [[ "$DRY_RUN" == false ]]; then
        echo
        info "Next steps:"
        echo "  1. Restart your terminal or run: source ~/.zshrc"
        echo "  2. Run 'system_status' to check your configuration"
        echo "  3. Run 'uniclip-status' to verify clipboard service"
        echo "  4. Start developing!"
        echo
        info "For troubleshooting, see: $DOTFILES_DIR/docs/PLATFORM_COMPARISON.md"
    fi
}

# Execute main function
main "$@"