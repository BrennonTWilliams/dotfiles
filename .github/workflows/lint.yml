name: Code Quality & Linting

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

# Cancel in-progress runs for the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Markdown Linting
  # ===========================================================================
  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint
        run: npm install -g markdownlint-cli

      - name: Run markdownlint
        continue-on-error: true
        run: |
          echo "## Markdown Linting Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run markdownlint on all markdown files
          if markdownlint '**/*.md' --ignore node_modules 2>&1 | tee markdown-lint.log; then
            echo "‚úÖ All markdown files pass linting" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Some markdown files have linting issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat markdown-lint.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Script Quality Checks
  # ===========================================================================
  script-quality:
    name: Script Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check script headers
        run: |
          echo "## Script Header Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          missing_shebang=0
          total_scripts=0

          # Check all shell scripts have proper shebang
          while IFS= read -r script; do
            total_scripts=$((total_scripts + 1))

            if ! head -1 "$script" | grep -q "^#!/.*sh"; then
              echo "‚ö†Ô∏è Missing shebang: $script"
              echo "- ‚ö†Ô∏è \`$script\` - Missing shebang" >> $GITHUB_STEP_SUMMARY
              missing_shebang=$((missing_shebang + 1))
            fi
          done < <(find . -name "*.sh" -type f -not -path "*/.git/*" -not -path "*/node_modules/*")

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Summary:** Checked $total_scripts scripts, $missing_shebang missing shebangs" >> $GITHUB_STEP_SUMMARY

          if [[ $missing_shebang -gt 0 ]]; then
            echo "‚ö†Ô∏è Some scripts are missing shebangs (non-critical)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ All scripts have proper shebangs" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for executable permissions
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Executable Permissions Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          non_executable=0

          # Check that scripts in certain directories are executable
          for dir in scripts tests; do
            if [[ -d "$dir" ]]; then
              while IFS= read -r script; do
                if [[ ! -x "$script" ]]; then
                  echo "‚ö†Ô∏è Not executable: $script"
                  echo "- ‚ö†Ô∏è \`$script\` - Not executable" >> $GITHUB_STEP_SUMMARY
                  non_executable=$((non_executable + 1))
                fi
              done < <(find "$dir" -name "*.sh" -type f)
            fi
          done

          if [[ $non_executable -gt 0 ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è Run: \`chmod +x <script>\` to fix" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ All scripts in scripts/ and tests/ are executable" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for TODO/FIXME comments
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Code Comments Review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find TODO and FIXME comments
          todo_count=$(grep -r "TODO" --include="*.sh" --include="*.toml" . 2>/dev/null | grep -v ".git" | wc -l || echo "0")
          fixme_count=$(grep -r "FIXME" --include="*.sh" --include="*.toml" . 2>/dev/null | grep -v ".git" | wc -l || echo "0")

          echo "- üìù TODO comments: $todo_count" >> $GITHUB_STEP_SUMMARY
          echo "- üîß FIXME comments: $fixme_count" >> $GITHUB_STEP_SUMMARY

          if [[ $todo_count -gt 0 ]] || [[ $fixme_count -gt 0 ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>View Comments</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -rn "TODO\|FIXME" --include="*.sh" --include="*.toml" . 2>/dev/null | grep -v ".git" | head -20 >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Security Checks
  # ===========================================================================
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          issues=0

          # Check for common secret patterns
          echo "### Checking for potential secrets..."

          # API keys
          if grep -rE "api[_-]?key.*=.*['\"][a-zA-Z0-9]{20,}['\"]" --include="*.sh" --include="*.toml" . 2>/dev/null | grep -v ".git"; then
            echo "‚ö†Ô∏è Potential API keys found"
            echo "- ‚ö†Ô∏è Potential API keys detected" >> $GITHUB_STEP_SUMMARY
            issues=$((issues + 1))
          fi

          # Passwords
          if grep -rE "password.*=.*['\"][^'\"]{8,}['\"]" --include="*.sh" --include="*.toml" . 2>/dev/null | grep -v ".git" | grep -v "template" | grep -v "example"; then
            echo "‚ö†Ô∏è Potential passwords found"
            echo "- ‚ö†Ô∏è Potential passwords detected" >> $GITHUB_STEP_SUMMARY
            issues=$((issues + 1))
          fi

          # SSH private keys
          if grep -r "BEGIN.*PRIVATE KEY" --include="*.sh" --include="*" . 2>/dev/null | grep -v ".git"; then
            echo "‚ùå Private keys found!"
            echo "- ‚ùå Private SSH keys detected" >> $GITHUB_STEP_SUMMARY
            issues=$((issues + 1))
          fi

          # Tokens
          if grep -rE "token.*=.*['\"][a-zA-Z0-9]{30,}['\"]" --include="*.sh" --include="*.toml" . 2>/dev/null | grep -v ".git" | grep -v "github_token" | grep -v "GITHUB_TOKEN"; then
            echo "‚ö†Ô∏è Potential tokens found"
            echo "- ‚ö†Ô∏è Potential authentication tokens detected" >> $GITHUB_STEP_SUMMARY
            issues=$((issues + 1))
          fi

          if [[ $issues -eq 0 ]]; then
            echo "‚úÖ No obvious secrets detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è Please review potential secrets manually" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for insecure practices
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Insecure Practice Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          issues=0

          # Check for curl without verification
          if grep -r "curl.*-k\|curl.*--insecure" --include="*.sh" . 2>/dev/null | grep -v ".git"; then
            echo "- ‚ö†Ô∏è Found \`curl\` with disabled SSL verification" >> $GITHUB_STEP_SUMMARY
            issues=$((issues + 1))
          fi

          # Check for wget without verification
          if grep -r "wget.*--no-check-certificate" --include="*.sh" . 2>/dev/null | grep -v ".git"; then
            echo "- ‚ö†Ô∏è Found \`wget\` with disabled certificate verification" >> $GITHUB_STEP_SUMMARY
            issues=$((issues + 1))
          fi

          # Check for eval usage (potentially dangerous)
          if grep -r "eval " --include="*.sh" . 2>/dev/null | grep -v ".git" | grep -v "# eval"; then
            echo "- ‚ö†Ô∏è Found \`eval\` usage (review for safety)" >> $GITHUB_STEP_SUMMARY
            issues=$((issues + 1))
          fi

          if [[ $issues -eq 0 ]]; then
            echo "‚úÖ No obvious insecure practices detected" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # File Organization Check
  # ===========================================================================
  file-organization:
    name: File Organization
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check file naming conventions
        run: |
          echo "## File Naming Convention Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          issues=0

          # Check for spaces in filenames (not recommended)
          while IFS= read -r file; do
            if [[ -f "$file" ]]; then
              basename=$(basename "$file")
              if [[ "$basename" =~ \  ]]; then
                echo "‚ö†Ô∏è Filename contains spaces: $file"
                echo "- ‚ö†Ô∏è \`$file\` - Contains spaces" >> $GITHUB_STEP_SUMMARY
                issues=$((issues + 1))
              fi
            fi
          done < <(find . -type f -not -path "*/.git/*" -not -path "*/node_modules/*")

          if [[ $issues -eq 0 ]]; then
            echo "‚úÖ All files follow naming conventions" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check directory structure
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Directory Structure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List main directories
          echo "Main directories:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find . -maxdepth 1 -type d -not -name ".*" -not -name "node_modules" | sort >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Documentation Check
  # ===========================================================================
  documentation-check:
    name: Documentation Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for required documentation
        run: |
          echo "## Documentation Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for essential documentation files
          docs_found=0
          docs_missing=0

          for doc in README.md LICENSE CONTRIBUTING.md; do
            if [[ -f "$doc" ]]; then
              echo "- ‚úÖ \`$doc\` exists" >> $GITHUB_STEP_SUMMARY
              docs_found=$((docs_found + 1))
            else
              echo "- ‚ö†Ô∏è \`$doc\` missing (optional)" >> $GITHUB_STEP_SUMMARY
              docs_missing=$((docs_missing + 1))
            fi
          done

          # Check for docs directory
          if [[ -d "docs" ]]; then
            doc_count=$(find docs -name "*.md" -type f | wc -l)
            echo "- ‚úÖ \`docs/\` directory exists with $doc_count files" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check README completeness
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## README.md Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ -f "README.md" ]]; then
            # Check for common sections
            has_installation=$(grep -i "installation\|install\|setup" README.md && echo "yes" || echo "no")
            has_usage=$(grep -i "usage\|how to use" README.md && echo "yes" || echo "no")
            has_features=$(grep -i "features" README.md && echo "yes" || echo "no")

            if [[ "$has_installation" == "yes" ]]; then
              echo "- ‚úÖ Installation section found" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ‚ö†Ô∏è Installation section not found" >> $GITHUB_STEP_SUMMARY
            fi

            if [[ "$has_usage" == "yes" ]]; then
              echo "- ‚úÖ Usage section found" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ‚ö†Ô∏è Usage section not found" >> $GITHUB_STEP_SUMMARY
            fi

            if [[ "$has_features" == "yes" ]]; then
              echo "- ‚úÖ Features section found" >> $GITHUB_STEP_SUMMARY
            fi

            # Count lines
            line_count=$(wc -l < README.md)
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üìÑ README.md has $line_count lines" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Summary
  # ===========================================================================
  lint-summary:
    name: Linting Summary
    runs-on: ubuntu-latest
    needs: [markdown-lint, script-quality, security-scan, file-organization, documentation-check]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # All jobs are allowed to pass with warnings, so we just report status
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.markdown-lint.result }}" == "success" ]]; then
            echo "- ‚úÖ Markdown Linting" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ö†Ô∏è Markdown Linting (warnings)" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.script-quality.result }}" == "success" ]]; then
            echo "- ‚úÖ Script Quality" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ö†Ô∏è Script Quality (warnings)" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.security-scan.result }}" == "success" ]]; then
            echo "- ‚úÖ Security Scan" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ö†Ô∏è Security Scan (warnings)" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.file-organization.result }}" == "success" ]]; then
            echo "- ‚úÖ File Organization" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ö†Ô∏è File Organization (warnings)" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.documentation-check.result }}" == "success" ]]; then
            echo "- ‚úÖ Documentation" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ö†Ô∏è Documentation (warnings)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ÑπÔ∏è Linting jobs provide warnings and suggestions but do not fail the build" >> $GITHUB_STEP_SUMMARY
